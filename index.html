<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高等数学课堂随机提问系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0a0e2a, #1a2980);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }
        
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        
        .star {
            position: absolute;
            background-color: white;
            border-radius: 50%;
            animation: twinkle 2s infinite alternate;
        }
        
        @keyframes twinkle {
            0% { opacity: 0.2; }
            100% { opacity: 1; }
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
            position: relative;
            z-index: 1;
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 20px;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.7);
            background: linear-gradient(to right, #4facfe, #00f2fe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .password-section {
            background: rgba(255, 255, 255, 0.08);
            padding: 40px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .password-section h2 {
            margin-bottom: 25px;
            font-size: 1.8rem;
            color: #a3d9ff;
        }
        
        .password-section input {
            padding: 15px 25px;
            font-size: 1.3rem;
            border: none;
            border-radius: 10px;
            margin-right: 15px;
            width: 300px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s;
        }
        
        .password-section input:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 15px rgba(79, 172, 254, 0.5);
        }
        
        .password-section button {
            padding: 15px 35px;
            font-size: 1.3rem;
            background: linear-gradient(to right, #4facfe, #00f2fe);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .password-section button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        .main-content {
            display: none;
            background: rgba(255, 255, 255, 0.08);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .image-container {
            margin: 20px auto 40px;
            position: relative;
            width: 250px;
            height: 250px;
        }
        
        .student-image {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            border: 5px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 40px rgba(79, 172, 254, 0.7);
            display: none;
            /* 美颜增白滤镜效果 */
            filter: 
                brightness(1.2) 
                contrast(1.15) 
                saturate(1.25)
                hue-rotate(-5deg)
                sepia(0.05);
            animation: imageGlow 2s infinite alternate;
            position: relative;
            z-index: 2;
        }
        
        /* 添加柔光效果层 */
        .image-container::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: radial-gradient(circle at center, rgba(255,255,255,0.4) 0%, transparent 70%);
            border-radius: 50%;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        .student-image.active + .image-container::before {
            opacity: 1;
        }
        
        @keyframes imageGlow {
            0% { 
                box-shadow: 0 0 30px rgba(79, 172, 254, 0.5);
                filter: 
                    brightness(1.2) 
                    contrast(1.15) 
                    saturate(1.25)
                    hue-rotate(-5deg)
                    sepia(0.05);
            }
            100% { 
                box-shadow: 0 0 50px rgba(79, 172, 254, 0.9);
                filter: 
                    brightness(1.25) 
                    contrast(1.2) 
                    saturate(1.3)
                    hue-rotate(-5deg)
                    sepia(0.08);
            }
        }
        
        .student-display {
            height: 200px;
            margin: 30px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .student-name {
            font-size: 3.2rem;
            font-weight: bold;
            color: #ffffff;
            transition: all 0.3s ease;
            position: absolute;
            width: 100%;
            text-align: center;
        }
        
        .student-name.rolling {
            animation: rollEffect 0.1s linear infinite;
        }
        
        @keyframes rollEffect {
            0% {
                transform: translateY(100%);
                opacity: 0;
            }
            10% {
                transform: translateY(0);
                opacity: 1;
            }
            90% {
                transform: translateY(0);
                opacity: 1;
            }
            100% {
                transform: translateY(-100%);
                opacity: 0;
            }
        }
        
        .student-name.selected {
            color: #ffeb3b;
            text-shadow: 0 0 20px rgba(255, 235, 59, 0.8);
            animation: selectedEffect 3s infinite alternate;
        }
        
        @keyframes selectedEffect {
            0% {
                transform: scale(0.95);
                text-shadow: 0 0 15px rgba(255, 235, 59, 0.7);
            }
            100% {
                transform: scale(1.05);
                text-shadow: 0 0 25px rgba(255, 235, 59, 0.9);
            }
        }
        
        .controls {
            margin: 40px 0 20px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .controls button {
            padding: 18px 40px;
            font-size: 1.4rem;
            background: linear-gradient(to right, #4facfe, #00f2fe);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .controls button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        .controls button.stop {
            background: linear-gradient(to right, #ff5e7d, #ff8a00);
        }
        
        .controls button.specify {
            background: linear-gradient(to right, #9c27b0, #e91e63);
        }
        
        .controls button.scoreboard {
            background: linear-gradient(to right, #4caf50, #8bc34a);
        }
        
        .specify-section {
            margin-top: 30px;
            display: none;
            background: rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 15px;
        }
        
        .specify-section h3 {
            margin-bottom: 20px;
            font-size: 1.6rem;
            color: #a3d9ff;
        }
        
        .specify-section select {
            padding: 12px 20px;
            font-size: 1.3rem;
            border: none;
            border-radius: 8px;
            margin-right: 15px;
            width: 250px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .specify-section button {
            padding: 12px 30px;
            font-size: 1.3rem;
            background: linear-gradient(to right, #9c27b0, #e91e63);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .specify-section button:hover {
            transform: translateY(-2px);
        }
        
        .score-section {
            margin-top: 30px;
            display: none;
            background: rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 15px;
        }
        
        .score-section h3 {
            margin-bottom: 20px;
            font-size: 1.6rem;
            color: #a3d9ff;
        }
        
        .score-section input {
            padding: 12px 20px;
            font-size: 1.3rem;
            border: none;
            border-radius: 8px;
            margin-right: 15px;
            width: 180px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .score-section button {
            padding: 12px 30px;
            font-size: 1.3rem;
            background: linear-gradient(to right, #4facfe, #00f2fe);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .score-section button:hover {
            transform: translateY(-2px);
        }
        
        .message {
            font-size: 1.8rem;
            margin: 25px 0;
            color: #ffeb3b;
            text-shadow: 0 0 10px rgba(255, 235, 59, 0.7);
            animation: messagePulse 2s infinite alternate;
        }
        
        @keyframes messagePulse {
            0% { opacity: 0.8; }
            100% { opacity: 1; }
        }
        
        .celebration {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 10;
            display: none;
        }
        
        .firework {
            position: absolute;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            animation: firework 1.5s ease-out forwards;
        }
        
        @keyframes firework {
            0% {
                transform: translate(var(--x), var(--y));
                width: 5px;
                height: 5px;
                opacity: 1;
            }
            50% {
                width: 5px;
                height: 5px;
                opacity: 1;
            }
            100% {
                width: 200px;
                height: 200px;
                opacity: 0;
            }
        }
        
        .sparkle {
            position: absolute;
            width: 20px;
            height: 20px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="yellow" d="M12,2L9,12L2,12L10,17L7,22L12,17L17,22L14,17L22,12L15,12L12,2Z"/></svg>') no-repeat center;
            background-size: contain;
            animation: sparkle 2s infinite alternate;
        }
        
        @keyframes sparkle {
            0% { transform: scale(0.8) rotate(0deg); opacity: 0.7; }
            100% { transform: scale(1.2) rotate(180deg); opacity: 1; }
        }
        
        .system-info {
            margin-top: 30px;
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.6);
        }
        
        .save-status {
            margin-top: 15px;
            font-size: 1rem;
            color: #4caf50;
            display: none;
        }

        /* GitHub Token 设置区域 */
        .github-token-section {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            z-index: 100;
            width: 300px;
            transition: all 0.3s ease;
        }

        .github-token-section.collapsed {
            width: 50px;
            height: 50px;
            overflow: hidden;
        }

        .github-token-section.collapsed .token-content {
            display: none;
        }

        .token-toggle {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .token-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .token-content h4 {
            margin-bottom: 10px;
            color: #a3d9ff;
            font-size: 0.9rem;
        }

        .token-content input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            color: white;
            font-size: 0.8rem;
        }

        .token-content button {
            width: 100%;
            padding: 8px;
            background: linear-gradient(to right, #4facfe, #00f2fe);
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .token-content button:hover {
            opacity: 0.9;
        }

        .token-status {
            margin-top: 8px;
            font-size: 0.7rem;
            color: #4caf50;
            display: none;
        }

        /* 得分榜弹窗样式 */
        .scoreboard-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .scoreboard-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1a2980, #26d0ce);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
            min-width: 500px;
            max-width: 80%;
            max-height: 80%;
            overflow-y: auto;
        }

        .scoreboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .scoreboard-header h2 {
            color: #ffeb3b;
            font-size: 2rem;
            text-shadow: 0 0 10px rgba(255, 235, 59, 0.5);
        }

        .close-scoreboard {
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-scoreboard:hover {
            color: #ffeb3b;
        }

        .refresh-scoreboard {
            background: linear-gradient(to right, #4caf50, #8bc34a);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
        }

        .refresh-scoreboard:hover {
            opacity: 0.9;
        }

        .scoreboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .scoreboard-table th,
        .scoreboard-table td {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .scoreboard-table th {
            background: rgba(255, 255, 255, 0.1);
            color: #ffeb3b;
            font-size: 1.2rem;
        }

        .scoreboard-table td {
            font-size: 1.1rem;
        }

        .scoreboard-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .scoreboard-table tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.03);
        }

        .loading-message {
            text-align: center;
            padding: 20px;
            color: #a3d9ff;
            font-size: 1.2rem;
        }

        .error-message {
            text-align: center;
            padding: 20px;
            color: #ff6b6b;
            font-size: 1.1rem;
        }
    </style>
</head>
<body>
    <div class="stars" id="stars"></div>
    <div class="celebration" id="celebration"></div>
    
    <div class="container">
        <h1>高等数学课堂提问计分系统</h1>
        
        <div class="password-section" id="passwordSection">
            <h2>请输入密码启动系统</h2>
            <input type="password" id="passwordInput" placeholder="请输入密码">
            <button id="submitPassword">确认</button>
        </div>
        
        <div class="main-content" id="mainContent">
            <div class="image-container">
                <img class="student-image" id="studentImage" alt="学生头像">
            </div>
            
            <div class="student-display">
                <div class="student-name" id="studentName"></div>
            </div>
            
            <div class="message" id="message"></div>
            
            <div class="controls">
                <button id="startBtn">开始点名</button>
                <button id="stopBtn" class="stop">停止点名</button>
                <button id="specifyBtn" class="specify">指定学生</button>
                <button id="scoreboardBtn" class="scoreboard">得分榜</button>
            </div>
            
            <div class="specify-section" id="specifySection">
                <h3>请选择要指定的学生</h3>
                <select id="studentSelect">
                    <option value="">-- 请选择学生 --</option>
                </select>
                <button id="confirmSpecify">确认指定</button>
            </div>
            
            <div class="score-section" id="scoreSection">
                <h3>请为 <span id="scoringStudent"></span> 同学打分</h3>
                <input type="number" id="scoreInput" min="-100" max="100" placeholder="输入分数 (-100到100)">
                <button id="submitScore">提交分数</button>
                <div class="save-status" id="saveStatus"></div>
            </div>
            
            <div class="system-info">
                <p>系统提示：点击"开始点名"按钮开始随机选择学生，点击"停止点名"按钮可提前结束选择，点击"指定学生"按钮可手动选择学生</p>
                <p style="margin-top: 10px; color: #4caf50;">分数将自动保存到远程服务器</p>
                <p style="margin-top: 5px; color: #ff9800;">2025级高数B3班专享</p>
            </div>
        </div>
    </div>

    <!-- GitHub Token 设置区域 -->
    <div class="github-token-section collapsed" id="githubTokenSection">
        <button class="token-toggle" id="tokenToggle">⚙️</button>
        <div class="token-content">
            <h4>GitHub Token 设置</h4>
            <input type="password" id="githubTokenInput" placeholder="输入 GitHub Token">
            <button id="saveToken">保存 Token</button>
            <div class="token-status" id="tokenStatus">Token 已保存</div>
        </div>
    </div>

    <!-- 得分榜弹窗 -->
    <div class="scoreboard-modal" id="scoreboardModal">
        <div class="scoreboard-content">
            <div class="scoreboard-header">
                <h2>得分榜</h2>
                <div>
                    <button class="refresh-scoreboard" id="refreshScoreboard">刷新</button>
                    <button class="close-scoreboard" id="closeScoreboard">&times;</button>
                </div>
            </div>
            <div id="scoreboardData">
                <div class="loading-message">正在加载得分数据...</div>
            </div>
        </div>
    </div>

    <script>
        // 学生名单
        const students = [
            "徐若伽", "程子昂", "朱静蕾", "王硕", "邹健乐", "吴子涵", "张怡", "胡恒远", "夏天香", "谢涵",
            "朱芮", "李欣怡", "俞光燕", "郭英姿", "张天乐", "李乐乐", "李志豪", "杨硕", "杨鋆妍", "金宇",
            "胡文远", "胡雨欣", "常俊", "韦书成", "汤子扬", "阮家豪", "何俊杰", "单宇阳", "姚勇棋", "段海冰",
            "唐亚", "鲍瑞锋", "蔡贤运", "方海涛", "韦宇恒", "韦嘉乐", "王昊宇", "王瑞琦", "叶啟军", "年博一",
            "刘子龙", "刘瑞", "朱勋振", "张宇洋", "张浩宇", "李俊杰", "杨文宇", "杨树园", "杨盛浩", "唐志远",
            "夏云勇", "谢超", "毛运朝", "韦玉", "孙耀坤", "朱行跃", "陈启睿", "姚智鹏", "韩紫嫣", "王童",
            "叶婷婷", "童欣怡", "舒智文", "韩玉洁", "梁晖", "谭慧慧", "马鑫宇", "孔艺涵", "方玉达", "王梦云",
            "张梦婷", "房银霏", "梁心怡", "梁宇琨", "霍浩然", "丁宇轩", "马自红", "牛好", "江海涛", "张家福",
            "罗时武", "胡耀", "赵紫涵", "高庆鹏", "盛文涛", "卞勇乐", "朱贤涛", "张玉洁", "张鸣威", "张恒",
            "杨佳怡", "陈家乐", "明华东", "姚猛", "项可益", "湛益阳"
        ];

        // GitHub配置（用户名和仓库名称在代码中设置）
        const GITHUB_CONFIG = {
            owner: "QingYH",           // 替换为您的GitHub用户名
            repo: "RandRoll"            // 替换为您的仓库名称
        };

        // 创建闪烁的星星
        function createStars() {
            const starsContainer = document.getElementById('stars');
            const starCount = 150;
            
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.classList.add('star');
                
                // 随机位置和大小
                const size = Math.random() * 3 + 1;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.style.left = `${Math.random() * 100}%`;
                star.style.top = `${Math.random() * 100}%`;
                
                // 随机动画延迟
                star.style.animationDelay = `${Math.random() * 2}s`;
                
                starsContainer.appendChild(star);
            }
        }

        // 创建烟花效果
        function createFireworks() {
            const celebration = document.getElementById('celebration');
            celebration.style.display = 'block';
            
            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff'];
            
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const firework = document.createElement('div');
                    firework.classList.add('firework');
                    
                    // 随机颜色
                    const color = colors[Math.floor(Math.random() * colors.length)];
                    firework.style.backgroundColor = color;
                    
                    // 随机位置
                    const x = Math.random() * 100;
                    const y = Math.random() * 100;
                    firework.style.setProperty('--x', `${x}vw`);
                    firework.style.setProperty('--y', `${y}vh`);
                    
                    // 随机大小和动画延迟
                    firework.style.animationDelay = `${Math.random() * 0.5}s`;
                    
                    celebration.appendChild(firework);
                    
                    // 动画结束后移除元素
                    setTimeout(() => {
                        firework.remove();
                    }, 1500);
                }, i * 100);
            }
            
            // 5秒后隐藏庆祝效果
            setTimeout(() => {
                celebration.style.display = 'none';
            }, 5000);
        }

        // 创建闪烁的小星星效果
        function createSparkles() {
            const container = document.querySelector('.student-display');
            const sparkleCount = 10;
            
            for (let i = 0; i < sparkleCount; i++) {
                const sparkle = document.createElement('div');
                sparkle.classList.add('sparkle');
                
                // 随机位置
                sparkle.style.left = `${Math.random() * 100}%`;
                sparkle.style.top = `${Math.random() * 100}%`;
                
                // 随机动画延迟
                sparkle.style.animationDelay = `${Math.random() * 2}s`;
                
                container.appendChild(sparkle);
                
                // 5秒后移除
                setTimeout(() => {
                    sparkle.remove();
                }, 5000);
            }
        }

        // 获取保存的GitHub Token
        function getGitHubToken() {
            return localStorage.getItem('githubToken');
        }

        // 保存GitHub Token
        function saveGitHubToken(token) {
            localStorage.setItem('githubToken', token);
            showTokenStatus('Token 已保存');
        }

        // 清除GitHub Token
        function clearGitHubToken() {
            localStorage.removeItem('githubToken');
        }

        // 显示Token状态
        function showTokenStatus(message) {
            const statusElement = document.getElementById('tokenStatus');
            statusElement.textContent = message;
            statusElement.style.display = 'block';
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 3000);
        }

        // 保存分数到GitHub（追加模式）
        async function saveScoreToGitHub(studentName, score) {
            const token = getGitHubToken();
            
            // 检查GitHub配置是否完整
            if (!token) {
                showSaveStatus(false, '请先设置GitHub Token');
                return false;
            }

            if (!GITHUB_CONFIG.owner || GITHUB_CONFIG.owner === "YOUR_USERNAME" || 
                !GITHUB_CONFIG.repo || GITHUB_CONFIG.repo === "YOUR_REPO_NAME") {
                showSaveStatus(false, 'GitHub配置不完整，请检查代码中的GITHUB_CONFIG');
                return false;
            }

            const record = {
                name: studentName,
                score: score,
                date: new Date().toLocaleString('zh-CN')
            };
            
            const filename = `records/${studentName}.txt`;

            try {
                // 首先检查文件是否存在
                const checkResponse = await fetch(
                    `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${encodeURIComponent(filename)}`,
                    {
                        method: 'GET',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );

                let existingContent = '';
                let sha = null;

                if (checkResponse.status === 200) {
                    const fileData = await checkResponse.json();
                    sha = fileData.sha;
                    // 解码现有内容
                    existingContent = decodeURIComponent(escape(atob(fileData.content)));
                }

                // 构建新的文件内容（追加模式）
                const newRecord = `姓名：${record.name}\n分数：${record.score}\n日期：${record.date}\n${'-'.repeat(30)}\n`;
                const newContent = existingContent + newRecord;
                const encodedContent = btoa(unescape(encodeURIComponent(newContent)));

                // 创建或更新文件 - 使用英文commit message避免编码问题
                const response = await fetch(
                    `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${encodeURIComponent(filename)}`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: `Add score for ${studentName} - ${new Date().toISOString()}`,
                            content: encodedContent,
                            sha: sha,
                            branch: 'main'
                        })
                    }
                );

                if (response.ok) {
                    showSaveStatus(true, '分数已保存到GitHub仓库！');
                    return true;
                } else {
                    const error = await response.json();
                    showSaveStatus(false, `保存失败: ${error.message}`);
                    return false;
                }
            } catch (error) {
                showSaveStatus(false, `网络错误: ${error.message}`);
                return false;
            }
        }

        // 显示保存状态
        function showSaveStatus(success, message) {
            const statusElement = document.getElementById('saveStatus');
            statusElement.textContent = message;
            statusElement.style.color = success ? '#4caf50' : '#f44336';
            statusElement.style.display = 'block';
            
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 5000);
        }

        // 获取所有分数记录并计算总分
        async function getScoreboardData() {
            const token = getGitHubToken();
            
            if (!token) {
                return { error: '请先设置GitHub Token' };
            }

            try {
                // 获取records目录下的所有文件 - 使用encodeURIComponent处理路径
                const response = await fetch(
                    `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${encodeURIComponent('records')}`,
                    {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );

                if (!response.ok) {
                    if (response.status === 404) {
                        return { error: 'records目录不存在，请先创建records目录或保存一些分数数据' };
                    }
                    const errorData = await response.json();
                    return { error: `GitHub API错误: ${errorData.message}` };
                }

                const files = await response.json();
                
                // 检查是否是空目录
                if (!files || files.length === 0) {
                    return { error: 'records目录为空，请先保存一些分数数据' };
                }

                const scoreMap = new Map();

                // 处理每个文件
                for (const file of files) {
                    if (file.name.endsWith('.txt')) {
                        try {
                            // 获取文件内容
                            const fileResponse = await fetch(file.download_url);
                            if (!fileResponse.ok) {
                                console.warn(`无法获取文件 ${file.name} 的内容`);
                                continue;
                            }
                            
                            const content = await fileResponse.text();
                            console.log(`处理文件 ${file.name}:`, content);
                            
                            // 按分隔符分割记录
                            const records = content.split('-'.repeat(30));
                            const fileNameStudent = file.name.replace('.txt', '');
                            
                            for (const record of records) {
                                if (record.trim() === '') continue;
                                
                                const lines = record.split('\n');
                                let score = 0;
                                let foundScore = false;
                                
                                for (const line of lines) {
                                    const trimmedLine = line.trim();
                                    if (trimmedLine.startsWith('分数：')) {
                                        const scoreStr = trimmedLine.replace('分数：', '').trim();
                                        score = parseInt(scoreStr);
                                        if (!isNaN(score)) {
                                            foundScore = true;
                                            break;
                                        }
                                    }
                                }
                                
                                if (foundScore && !isNaN(score)) {
                                    // 累加同一学生的所有分数
                                    if (scoreMap.has(fileNameStudent)) {
                                        scoreMap.set(fileNameStudent, scoreMap.get(fileNameStudent) + score);
                                    } else {
                                        scoreMap.set(fileNameStudent, score);
                                    }
                                    console.log(`学生 ${fileNameStudent} 得分: ${score}, 当前总分: ${scoreMap.get(fileNameStudent)}`);
                                }
                            }
                        } catch (fileError) {
                            console.error(`处理文件 ${file.name} 时出错:`, fileError);
                        }
                    }
                }

                // 转换为数组并排序
                const scoreArray = Array.from(scoreMap.entries())
                    .map(([name, totalScore]) => ({ name, totalScore }))
                    .sort((a, b) => b.totalScore - a.totalScore);

                console.log('最终得分榜数据:', scoreArray);
                return { data: scoreArray };

            } catch (error) {
                console.error('获取得分榜数据失败:', error);
                return { error: `网络错误: ${error.message}` };
            }
        }

        // 显示得分榜
        async function showScoreboard() {
            const modal = document.getElementById('scoreboardModal');
            modal.style.display = 'block';
            await updateScoreboardDisplay();
        }

        // 更新得分榜显示
        async function updateScoreboardDisplay() {
            const scoreboardData = document.getElementById('scoreboardData');
            scoreboardData.innerHTML = '<div class="loading-message">正在加载得分数据...</div>';
            
            const result = await getScoreboardData();
            
            if (result.error) {
                scoreboardData.innerHTML = `<div class="error-message">${result.error}</div>`;
                return;
            }
            
            if (result.data && result.data.length > 0) {
                let html = `
                    <table class="scoreboard-table">
                        <thead>
                            <tr>
                                <th>排名</th>
                                <th>姓名</th>
                                <th>总分</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                result.data.forEach((item, index) => {
                    html += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${item.name}</td>
                            <td>${item.totalScore}</td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
                
                scoreboardData.innerHTML = html;
            } else {
                scoreboardData.innerHTML = '<div class="loading-message">暂无得分数据</div>';
            }
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            createStars();
            
            // GitHub Token 设置功能
            const tokenSection = document.getElementById('githubTokenSection');
            const tokenToggle = document.getElementById('tokenToggle');
            const saveTokenBtn = document.getElementById('saveToken');
            
            // 切换Token设置面板
            tokenToggle.addEventListener('click', function() {
                tokenSection.classList.toggle('collapsed');
            });
            
            // 保存Token
            saveTokenBtn.addEventListener('click', function() {
                const token = document.getElementById('githubTokenInput').value;
                if (token) {
                    saveGitHubToken(token);
                    document.getElementById('githubTokenInput').value = '';
                    tokenSection.classList.add('collapsed');
                } else {
                    showTokenStatus('请输入Token');
                }
            });
            
            // 加载已保存的Token
            const savedToken = getGitHubToken();
            if (savedToken) {
                showTokenStatus('Token 已加载');
            }
            
            // 得分榜功能
            document.getElementById('scoreboardBtn').addEventListener('click', showScoreboard);
            document.getElementById('refreshScoreboard').addEventListener('click', updateScoreboardDisplay);
            document.getElementById('closeScoreboard').addEventListener('click', function() {
                document.getElementById('scoreboardModal').style.display = 'none';
            });
            
            // 点击弹窗外部关闭
            document.getElementById('scoreboardModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
            
            // 填充学生选择下拉框
            const studentSelect = document.getElementById('studentSelect');
            students.forEach(student => {
                const option = document.createElement('option');
                option.value = student;
                option.textContent = student;
                studentSelect.appendChild(option);
            });
            
            // 密码验证 - 点击确认按钮
            document.getElementById('submitPassword').addEventListener('click', function() {
                checkPassword();
            });
            
            // 密码验证 - 按回车键
            document.getElementById('passwordInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    checkPassword();
                }
            });
            
            function checkPassword() {
                const password = document.getElementById('passwordInput').value;
                if (password === 'math123') {
                    document.getElementById('passwordSection').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                } else {
                    alert('密码错误，请重新输入！');
                    document.getElementById('passwordInput').value = '';
                    document.getElementById('passwordInput').focus();
                }
            }
            
            let isRolling = false;
            let rollInterval;
            let selectedStudent = '';
            let audio;
            
            // 开始点名
            document.getElementById('startBtn').addEventListener('click', function() {
                if (isRolling) return;
                
                isRolling = true;
                document.getElementById('studentImage').style.display = 'none';
                document.getElementById('message').textContent = '';
                document.getElementById('scoreSection').style.display = 'none';
                document.getElementById('specifySection').style.display = 'none';
                
                const studentNameElement = document.getElementById('studentName');
                studentNameElement.classList.remove('selected');
                studentNameElement.classList.add('rolling');
                
                // 播放背景音乐
                audio = new Audio('music/background.mp3');
                audio.loop = true;
                audio.play().catch(e => console.log('音频播放失败:', e));
                
                // 擦除式滚动效果
                let currentIndex = 0;
                
                rollInterval = setInterval(() => {
                    studentNameElement.textContent = students[currentIndex];
                    currentIndex = (currentIndex + 1) % students.length;
                }, 100);
                
                // 4秒后停止
                setTimeout(() => {
                    stopRolling();
                }, 4000);
            });
            
            // 停止点名
            document.getElementById('stopBtn').addEventListener('click', function() {
                if (!isRolling) return;
                stopRolling();
            });
            
            // 指定学生
            document.getElementById('specifyBtn').addEventListener('click', function() {
                document.getElementById('specifySection').style.display = 'block';
                document.getElementById('scoreSection').style.display = 'none';
            });
            
            // 确认指定学生
            document.getElementById('confirmSpecify').addEventListener('click', function() {
                const selected = document.getElementById('studentSelect').value;
                if (!selected) {
                    alert('请选择一名学生！');
                    return;
                }
                
                selectStudent(selected);
                document.getElementById('specifySection').style.display = 'none';
            });
            
            function stopRolling() {
                clearInterval(rollInterval);
                isRolling = false;
                
                const studentNameElement = document.getElementById('studentName');
                studentNameElement.classList.remove('rolling');
                
                // 随机选择学生
                selectedStudent = students[Math.floor(Math.random() * students.length)];
                selectStudent(selectedStudent);
            }
            
            function selectStudent(student) {
                selectedStudent = student;
                const studentNameElement = document.getElementById('studentName');
                studentNameElement.textContent = selectedStudent;
                studentNameElement.classList.add('selected');
                
                // 停止音乐
                if (audio) {
                    audio.pause();
                    audio.currentTime = 0;
                }
                
                // 显示学生头像并应用美颜效果
                const studentImage = document.getElementById('studentImage');
                studentImage.src = `images/${selectedStudent}.jpg`;
                studentImage.style.display = 'block';
                studentImage.classList.add('active');
                
                // 创建庆祝效果
                createFireworks();
                createSparkles();
                
                // 显示消息
                document.getElementById('message').textContent = `恭喜${selectedStudent}同学中奖啦！`;
                
                // 语音播报
                const speech = new SpeechSynthesisUtterance(`恭喜${selectedStudent}同学中奖啦`);
                speech.lang = 'zh-CN';
                speech.rate = 1.0;
                speech.pitch = 1.0;
                window.speechSynthesis.speak(speech);
                
                // 5秒后隐藏头像
                setTimeout(() => {
                    studentImage.style.display = 'none';
                    studentImage.classList.remove('active');
                    document.getElementById('scoreSection').style.display = 'block';
                    document.getElementById('scoringStudent').textContent = selectedStudent;
                }, 5000);
            }
            
            // 提交分数
            document.getElementById('submitScore').addEventListener('click', function() {
                const score = document.getElementById('scoreInput').value;
                
                if (score === '' || score < -100 || score > 100) {
                    alert('请输入-100到100之间的分数！');
                    return;
                }
                
                // 保存到GitHub
                saveScoreToGitHub(selectedStudent, score);
                
                document.getElementById('scoreInput').value = '';
                document.getElementById('scoreSection').style.display = 'none';
            });
        });
    </script>
</body>
</html>
