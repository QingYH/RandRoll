<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高等数学课堂随机提问系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            overflow-x: hidden;
        }
        
        .container {
            width: 100%;
            max-width: 900px;
            text-align: center;
        }
        
        h1 {
            margin: 20px 0;
            font-size: 2.5rem;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        
        .password-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .password-input {
            width: 100%;
            padding: 12px;
            margin: 15px 0;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            text-align: center;
            background: rgba(255, 255, 255, 0.9);
        }
        
        .btn {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .btn:hover {
            background: #3a7bc8;
            transform: translateY(-2px);
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .btn-start {
            background: #2ecc71;
        }
        
        .btn-start:hover {
            background: #27ae60;
        }
        
        .btn-stop {
            background: #e74c3c;
        }
        
        .btn-stop:hover {
            background: #c0392b;
        }
        
        .main-section {
            display: none;
            width: 100%;
        }
        
        .name-display {
            font-size: 3.5rem;
            font-weight: bold;
            margin: 30px 0;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
        }
        
        .name-scroll {
            font-size: 2rem;
            height: 80px;
            overflow: hidden;
            margin: 20px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .student-image {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            object-fit: cover;
            border: 5px solid white;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            margin: 20px auto;
            display: none;
            filter: brightness(1.1) contrast(1.1) saturate(1.2);
        }
        
        .score-section {
            margin: 30px 0;
            display: none;
        }
        
        .score-input {
            width: 100px;
            padding: 10px;
            margin: 10px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            text-align: center;
            background: rgba(255, 255, 255, 0.9);
        }
        
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        
        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 2s infinite;
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 1; }
        }
        
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #f00;
            opacity: 0;
        }
        
        .footer {
            margin-top: 30px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(46, 204, 113, 0.9);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1000;
        }
        
        .records-section {
            margin-top: 30px;
            width: 100%;
            max-width: 600px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            display: none;
        }
        
        .records-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
            text-align: left;
        }
        
        .record-item {
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
        }
        
        .record-item:last-child {
            border-bottom: none;
        }
        
        .records-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .file-handle-section {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="stars" id="stars"></div>
    <div class="container">
        <h1>高等数学课堂随机提问系统</h1>
        
        <div class="password-section" id="passwordSection">
            <h2>请输入密码进入系统</h2>
            <input type="password" class="password-input" id="passwordInput" placeholder="请输入密码">
            <button class="btn" id="loginBtn">进入系统</button>
        </div>
        
        <div class="main-section" id="mainSection">
            <div class="name-scroll" id="nameScroll">准备开始...</div>
            <div class="name-display" id="nameDisplay">等待点名</div>
            
            <img class="student-image" id="studentImage" src="" alt="学生头像">
            
            <div class="controls">
                <button class="btn btn-start" id="startBtn">开始点名</button>
                <button class="btn btn-stop" id="stopBtn" disabled>停止点名</button>
                <button class="btn" id="showRecordsBtn">查看记录</button>
            </div>
            
            <div class="score-section" id="scoreSection">
                <h3>请为 <span id="selectedStudentName"></span> 同学评分</h3>
                <input type="number" class="score-input" id="scoreInput" min="-100" max="100" placeholder="分数">
                <button class="btn" id="submitScoreBtn">提交分数</button>
            </div>
            
            <div class="file-handle-section">
                <p>请选择record文件夹保存分数记录</p>
                <button class="btn" id="selectFolderBtn">选择文件夹</button>
                <span id="folderStatus" style="margin-left: 10px;">未选择</span>
            </div>
            
            <div class="records-section" id="recordsSection">
                <div class="records-header">
                    <h3>学生提问记录</h3>
                    <button class="btn" id="closeRecordsBtn">关闭</button>
                </div>
                <div class="records-list" id="recordsList">
                    <!-- 记录将在这里显示 -->
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>高等数学课堂 &copy; 2023</p>
        </div>
    </div>
    
    <div class="notification" id="notification">分数已保存！</div>

    <script>
        // 学生名单
        const studentList = [
            "徐若伽", "程子昂", "朱静蕾", "王硕", "邹健乐", "吴子涵", "张怡", "胡恒远", "夏天香", "谢涵",
            "朱芮", "李欣怡", "俞光燕", "郭英姿", "张天乐", "李乐乐", "李志豪", "杨硕", "杨鋆妍", "金宇",
            "胡文远", "胡雨欣", "常俊", "韦书成", "汤子扬", "阮家豪", "何俊杰", "单宇阳", "姚勇棋", "段海冰",
            "唐亚", "鲍瑞锋", "蔡贤运", "方海涛", "韦宇恒", "韦嘉乐", "王昊宇", "王瑞琦", "叶啟军", "年博一",
            "刘子龙", "刘瑞", "朱勋振", "张宇洋", "张浩宇", "李俊杰", "杨文宇", "杨树园", "杨盛浩", "唐志远",
            "夏云勇", "谢超", "毛运朝", "韦玉", "孙耀坤", "朱行跃", "陈启睿", "姚智鹏", "韩紫嫣", "王童",
            "叶婷婷", "童欣怡", "舒智文", "韩玉洁", "梁晖", "谭慧慧", "马鑫宇", "孔艺涵", "方玉达", "王梦云",
            "张梦婷", "房银霏", "梁心怡", "梁宇琨", "霍浩然", "丁宇轩", "马自红", "牛好", "江海涛", "张家福",
            "罗时武", "胡耀", "赵紫涵", "高庆鹏", "盛文涛", "卞勇乐", "朱贤涛", "张玉洁", "张鸣威", "张恒",
            "杨佳怡", "陈家乐", "明华东", "姚猛", "项可益", "湛益阳"
        ];

        // 系统密码
        const SYSTEM_PASSWORD = "123456";
        
        // DOM元素
        const passwordSection = document.getElementById('passwordSection');
        const mainSection = document.getElementById('mainSection');
        const passwordInput = document.getElementById('passwordInput');
        const loginBtn = document.getElementById('loginBtn');
        const nameScroll = document.getElementById('nameScroll');
        const nameDisplay = document.getElementById('nameDisplay');
        const studentImage = document.getElementById('studentImage');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const scoreSection = document.getElementById('scoreSection');
        const selectedStudentName = document.getElementById('selectedStudentName');
        const scoreInput = document.getElementById('scoreInput');
        const submitScoreBtn = document.getElementById('submitScoreBtn');
        const starsContainer = document.getElementById('stars');
        const notification = document.getElementById('notification');
        const showRecordsBtn = document.getElementById('showRecordsBtn');
        const recordsSection = document.getElementById('recordsSection');
        const recordsList = document.getElementById('recordsList');
        const closeRecordsBtn = document.getElementById('closeRecordsBtn');
        const selectFolderBtn = document.getElementById('selectFolderBtn');
        const folderStatus = document.getElementById('folderStatus');
        
        // 系统变量
        let isRolling = false;
        let rollInterval;
        let selectedStudent = '';
        let audioContext;
        let backgroundMusic;
        let scoreRecords = [];
        let recordsFolderHandle = null;
        
        // 创建星星背景
        function createStars() {
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.classList.add('star');
                star.style.left = `${Math.random() * 100}%`;
                star.style.top = `${Math.random() * 100}%`;
                star.style.width = `${Math.random() * 3 + 1}px`;
                star.style.height = star.style.width;
                star.style.animationDelay = `${Math.random() * 2}s`;
                starsContainer.appendChild(star);
            }
        }
        
        // 登录验证
        loginBtn.addEventListener('click', function() {
            if (passwordInput.value === SYSTEM_PASSWORD) {
                passwordSection.style.display = 'none';
                mainSection.style.display = 'block';
                createStars();
                loadScoreRecords();
            } else {
                alert('密码错误，请重新输入！');
                passwordInput.value = '';
            }
        });
        
        // 按Enter键登录
        passwordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                loginBtn.click();
            }
        });
        
        // 选择文件夹
        selectFolderBtn.addEventListener('click', async function() {
            try {
                // 使用File System Access API选择文件夹
                if ('showDirectoryPicker' in window) {
                    recordsFolderHandle = await window.showDirectoryPicker();
                    folderStatus.textContent = `已选择: ${recordsFolderHandle.name}`;
                    folderStatus.style.color = '#2ecc71';
                    
                    // 加载已有的分数记录
                    await loadScoreRecords();
                } else {
                    alert('您的浏览器不支持文件系统访问API，请使用Chrome 86+或Edge 86+浏览器');
                }
            } catch (error) {
                console.error('选择文件夹失败:', error);
                if (error.name !== 'AbortError') {
                    alert('选择文件夹失败，请重试');
                }
            }
        });
        
        // 保存分数到文件
        async function saveScoreToFile(studentName, score) {
            if (!recordsFolderHandle) {
                alert('请先选择record文件夹');
                return;
            }
            
            try {
                const date = new Date().toLocaleString();
                const content = `姓名: ${studentName}\n得分: ${score}\n日期: ${date}`;
                
                // 创建或获取文件
                const fileHandle = await recordsFolderHandle.getFileHandle(`${studentName}.txt`, { create: true });
                const writable = await fileHandle.createWritable();
                
                // 写入内容
                await writable.write(content);
                await writable.close();
                
                // 添加到记录列表
                const record = {
                    name: studentName,
                    score: score,
                    date: date
                };
                scoreRecords.push(record);
                
                // 显示通知
                showNotification('分数已保存！');
            } catch (error) {
                console.error('保存文件失败:', error);
                alert('保存文件失败，请重试');
            }
        }
        
        // 加载分数记录
        async function loadScoreRecords() {
            if (!recordsFolderHandle) return;
            
            try {
                scoreRecords = [];
                
                // 遍历文件夹中的所有文件
                for await (const entry of recordsFolderHandle.values()) {
                    if (entry.kind === 'file' && entry.name.endsWith('.txt')) {
                        try {
                            const file = await entry.getFile();
                            const text = await file.text();
                            
                            // 解析文件内容
                            const lines = text.split('\n');
                            const name = lines[0].replace('姓名: ', '').trim();
                            const score = lines[1].replace('得分: ', '').trim();
                            const date = lines[2].replace('日期: ', '').trim();
                            
                            scoreRecords.push({
                                name: name,
                                score: score,
                                date: date
                            });
                        } catch (error) {
                            console.error(`读取文件 ${entry.name} 失败:`, error);
                        }
                    }
                }
                
                // 按日期排序
                scoreRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
            } catch (error) {
                console.error('加载记录失败:', error);
            }
        }
        
        // 开始点名
        startBtn.addEventListener('click', function() {
            if (isRolling) return;
            
            isRolling = true;
            startBtn.disabled = true;
            stopBtn.disabled = false;
            nameDisplay.textContent = '';
            nameDisplay.style.fontSize = '2rem';
            studentImage.style.display = 'none';
            scoreSection.style.display = 'none';
            recordsSection.style.display = 'none';
            
            // 播放背景音乐
            playBackgroundMusic();
            
            // 开始滚动显示名字
            let counter = 0;
            rollInterval = setInterval(function() {
                const randomIndex = Math.floor(Math.random() * studentList.length);
                nameScroll.textContent = studentList[randomIndex];
                counter++;
                
                // 4秒后自动停止
                if (counter >= 40) {
                    stopRolling();
                }
            }, 100);
        });
        
        // 停止点名
        stopBtn.addEventListener('click', function() {
            stopRolling();
        });
        
        // 停止滚动并选择学生
        function stopRolling() {
            if (!isRolling) return;
            
            clearInterval(rollInterval);
            isRolling = false;
            startBtn.disabled = false;
            stopBtn.disabled = true;
            
            // 随机选择一名学生
            const randomIndex = Math.floor(Math.random() * studentList.length);
            selectedStudent = studentList[randomIndex];
            
            // 停止背景音乐
            stopBackgroundMusic();
            
            // 显示选中的学生
            nameScroll.textContent = '';
            nameDisplay.textContent = selectedStudent;
            nameDisplay.style.fontSize = '4rem';
            
            // 显示学生头像
            studentImage.src = `images/${selectedStudent}.jpg`;
            studentImage.style.display = 'block';
            
            // 创建庆祝效果
            createCelebration();
            
            // 语音播报
            speakText(`恭喜${selectedStudent}同学中奖啦`);
            
            // 3秒后显示评分界面
            setTimeout(function() {
                studentImage.style.display = 'none';
                scoreSection.style.display = 'block';
                selectedStudentName.textContent = selectedStudent;
            }, 3000);
        }
        
        // 播放背景音乐
        function playBackgroundMusic() {
            // 在实际应用中，这里应该播放指定的背景音乐
            // backgroundMusic = new Audio('music/background.mp3');
            // backgroundMusic.loop = true;
            // backgroundMusic.play();
            
            // 由于安全限制，这里使用控制台输出代替
            console.log('播放背景音乐: background.mp3');
        }
        
        // 停止背景音乐
        function stopBackgroundMusic() {
            // 在实际应用中，这里应该停止背景音乐
            // if (backgroundMusic) {
            //     backgroundMusic.pause();
            //     backgroundMusic.currentTime = 0;
            // }
            
            console.log('停止背景音乐');
        }
        
        // 语音播报
        function speakText(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 1.0;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                speechSynthesis.speak(utterance);
            }
        }
        
        // 创建庆祝效果（撒花、星星闪烁）
        function createCelebration() {
            // 创建彩色小星星
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const star = document.createElement('div');
                    star.classList.add('star');
                    star.style.left = `${Math.random() * 100}%`;
                    star.style.top = `${Math.random() * 100}%`;
                    star.style.width = `${Math.random() * 5 + 3}px`;
                    star.style.height = star.style.width;
                    star.style.background = `hsl(${Math.random() * 360}, 100%, 50%)`;
                    star.style.animation = `twinkle ${Math.random() * 1 + 0.5}s infinite`;
                    document.body.appendChild(star);
                    
                    // 3秒后移除星星
                    setTimeout(() => {
                        star.remove();
                    }, 3000);
                }, i * 50);
            }
            
            // 创建彩色纸屑
            for (let i = 0; i < 100; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.classList.add('confetti');
                    confetti.style.left = `${Math.random() * 100}%`;
                    confetti.style.top = `${Math.random() * 100}%`;
                    confetti.style.background = `hsl(${Math.random() * 360}, 100%, 50%)`;
                    confetti.style.opacity = '1';
                    confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                    document.body.appendChild(confetti);
                    
                    // 动画
                    confetti.animate([
                        { transform: `translateY(0) rotate(0deg)`, opacity: 1 },
                        { transform: `translateY(${Math.random() * 200 + 100}px) rotate(${Math.random() * 360}deg)`, opacity: 0 }
                    ], {
                        duration: 2000,
                        easing: 'cubic-bezier(0.215, 0.61, 0.355, 1)'
                    });
                    
                    // 3秒后移除纸屑
                    setTimeout(() => {
                        confetti.remove();
                    }, 3000);
                }, i * 20);
            }
        }
        
        // 显示通知
        function showNotification(message) {
            notification.textContent = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        // 显示记录
        function displayRecords() {
            recordsList.innerHTML = '';
            
            if (scoreRecords.length === 0) {
                recordsList.innerHTML = '<p>暂无记录</p>';
                return;
            }
            
            scoreRecords.forEach(record => {
                const recordItem = document.createElement('div');
                recordItem.className = 'record-item';
                recordItem.innerHTML = `
                    <div>
                        <strong>${record.name}</strong>
                        <div style="font-size: 0.8rem; color: rgba(255,255,255,0.7)">${record.date}</div>
                    </div>
                    <div style="font-weight: bold; font-size: 1.2rem">${record.score}</div>
                `;
                recordsList.appendChild(recordItem);
            });
        }
        
        // 提交分数
        submitScoreBtn.addEventListener('click', function() {
            const score = scoreInput.value;
            if (!score || score < -100 || score > 100) {
                alert('请输入有效的分数（-100到100）');
                return;
            }
            
            // 保存分数到文件
            saveScoreToFile(selectedStudent, score);
            
            // 重置界面
            scoreInput.value = '';
            scoreSection.style.display = 'none';
            nameDisplay.textContent = '等待点名';
            nameDisplay.style.fontSize = '3.5rem';
        });
        
        // 按Enter键提交分数
        scoreInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                submitScoreBtn.click();
            }
        });
        
        // 显示记录
        showRecordsBtn.addEventListener('click', function() {
            displayRecords();
            recordsSection.style.display = 'block';
        });
        
        // 关闭记录
        closeRecordsBtn.addEventListener('click', function() {
            recordsSection.style.display = 'none';
        });
    </script>
</body>
</html>
