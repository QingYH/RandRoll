<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高等数学课堂随机提问系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2980, #26d0ce);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            width: 90%;
            max-width: 1200px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5rem;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        
        .password-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .password-input {
            display: flex;
            gap: 10px;
        }
        
        input {
            padding: 12px 15px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.9);
            width: 200px;
        }
        
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            background: #4a54e1;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        button:hover {
            background: #3a44d1;
            transform: translateY(-2px);
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        .main-section {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 30px;
        }
        
        .display-area {
            display: flex;
            width: 100%;
            gap: 30px;
            justify-content: space-between;
        }
        
        .student-display {
            flex: 1;
            height: 250px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3rem;
            font-weight: bold;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .avatar-display {
            flex: 1;
            height: 250px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }
        
        .student-avatar {
            display: none;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            object-fit: cover;
            border: 5px solid white;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.7);
            z-index: 10;
            /* 美颜滤镜效果 */
            filter: brightness(1.1) contrast(1.05) saturate(1.2) hue-rotate(-5deg);
        }
        
        .default-avatar {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            object-fit: cover;
            border: 5px solid white;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.7);
            filter: brightness(1.1) contrast(1.1) saturate(1.2);
        }
        
        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .score-section {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.15);
            padding: 20px;
            border-radius: 15px;
            width: 100%;
        }
        
        .score-input {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #f00;
            opacity: 0.8;
            border-radius: 50%;
            animation: fall 3s linear forwards;
        }
        
        .star {
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: #ff0;
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            animation: twinkle 1.5s infinite alternate;
        }
        
        @keyframes fall {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(500px) rotate(360deg);
                opacity: 0;
            }
        }
        
        @keyframes twinkle {
            0% {
                opacity: 0.3;
                transform: scale(0.8);
            }
            100% {
                opacity: 1;
                transform: scale(1.2);
            }
        }
        
        .status {
            margin-top: 20px;
            font-size: 1.2rem;
            text-align: center;
            min-height: 30px;
        }
        
        .footer {
            margin-top: 30px;
            text-align: center;
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .loading {
            display: none;
            margin-top: 10px;
        }
        
        .loading-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: white;
            margin: 0 3px;
            animation: loading 1.4s infinite ease-in-out both;
        }
        
        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes loading {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        
        .success-message {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .error-message {
            color: #f44336;
            font-weight: bold;
        }
        
        .timer {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.2rem;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 10px;
        }
        
        .beauty-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.3) 0%, transparent 50%);
            mix-blend-mode: overlay;
            pointer-events: none;
            display: none;
        }
    </style>
</head>
<body>
    <h1>高等数学课堂随机提问系统</h1>
    
    <div class="container">
        <div class="password-section" id="passwordSection">
            <h2>请输入密码启动系统</h2>
            <div class="password-input">
                <input type="password" id="passwordInput" placeholder="请输入密码">
                <button id="startBtn">启动系统</button>
            </div>
        </div>
        
        <div class="main-section" id="mainSection">
            <div class="display-area">
                <div class="student-display" id="studentDisplay">
                    <div id="studentName">准备开始</div>
                    <div class="timer" id="timer">4秒</div>
                </div>
                <div class="avatar-display" id="avatarDisplay">
                    <img id="studentAvatar" class="student-avatar" alt="学生头像">
                    <img id="defaultAvatar" class="default-avatar" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200' viewBox='0 0 200 200'%3E%3Ccircle cx='100' cy='100' r='90' fill='%23FFD700'/%3E%3Cpath d='M100,30 L110,80 L160,80 L120,110 L130,160 L100,130 L70,160 L80,110 L40,80 L90,80 Z' fill='%23FFFFFF'/%3E%3C/svg%3E" alt="幸运星头像">
                    <div class="beauty-overlay" id="beautyOverlay"></div>
                </div>
            </div>
            
            <div class="controls">
                <button id="startRollBtn">开始点名</button>
                <button id="stopRollBtn" disabled>停止点名</button>
            </div>
            
            <div class="score-section" id="scoreSection">
                <h3>请为 <span id="selectedStudentName"></span> 同学打分</h3>
                <div class="score-input">
                    <input type="number" id="scoreInput" min="-100" max="100" placeholder="请输入分数 (-100到100)">
                    <button id="submitScoreBtn">提交分数</button>
                </div>
                <div class="loading" id="loadingIndicator">
                    <span class="loading-dot"></span>
                    <span class="loading-dot"></span>
                    <span class="loading-dot"></span>
                    <span>正在发送邮件...</span>
                </div>
            </div>
            
            <div class="status" id="status"></div>
        </div>
    </div>
    
    <div class="footer">
        高等数学课堂随机提问系统 &copy; 2023
    </div>
    
    <script>
        // 系统密码
        const SYSTEM_PASSWORD = "math123";
        
        // 学生名单
        const studentList = [
            "徐若伽", "程子昂", "朱静蕾", "王硕", "邹健乐", "吴子涵", "张怡", "胡恒远", 
            "夏天香", "谢涵", "朱芮", "李欣怡", "俞光燕", "郭英姿", "张天乐", "李乐乐", 
            "李志豪", "杨硕", "杨鋆妍", "金宇", "胡文远", "胡雨欣", "常俊", "韦书成", 
            "汤子扬", "阮家豪", "何俊杰", "单宇阳", "姚勇棋", "段海冰", "唐亚", "鲍瑞锋", 
            "蔡贤运", "方海涛", "韦宇恒", "韦嘉乐", "王昊宇", "王瑞琦", "叶啟军", "年博一", 
            "刘子龙", "刘瑞", "朱勋振", "张宇洋", "张浩宇", "李俊杰", "杨文宇", "杨树园", 
            "杨盛浩", "唐志远", "夏云勇", "谢超", "毛运朝", "韦玉", "孙耀坤", "朱行跃", 
            "陈启睿", "姚智鹏", "韩紫嫣", "王童", "叶婷婷", "童欣怡", "舒智文", "韩玉洁", 
            "梁晖", "谭慧慧", "马鑫宇", "孔艺涵", "方玉达", "王梦云", "张梦婷", "房银霏", 
            "梁心怡", "梁宇琨", "霍浩然", "丁宇轩", "马自红", "牛好", "江海涛", "张家福", 
            "罗时武", "胡耀", "赵紫涵", "高庆鹏", "盛文涛", "卞勇乐", "朱贤涛", "张玉洁", 
            "张鸣威", "张恒", "杨佳怡", "陈家乐", "明华东", "姚猛", "项可益", "湛益阳"
        ];
        
        // DOM元素
        const passwordSection = document.getElementById('passwordSection');
        const mainSection = document.getElementById('mainSection');
        const passwordInput = document.getElementById('passwordInput');
        const startBtn = document.getElementById('startBtn');
        const studentDisplay = document.getElementById('studentDisplay');
        const studentName = document.getElementById('studentName');
        const avatarDisplay = document.getElementById('avatarDisplay');
        const studentAvatar = document.getElementById('studentAvatar');
        const defaultAvatar = document.getElementById('defaultAvatar');
        const startRollBtn = document.getElementById('startRollBtn');
        const stopRollBtn = document.getElementById('stopRollBtn');
        const scoreSection = document.getElementById('scoreSection');
        const selectedStudentName = document.getElementById('selectedStudentName');
        const scoreInput = document.getElementById('scoreInput');
        const submitScoreBtn = document.getElementById('submitScoreBtn');
        const status = document.getElementById('status');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const timer = document.getElementById('timer');
        const beautyOverlay = document.getElementById('beautyOverlay');
        
        // 系统变量
        let isRolling = false;
        let rollInterval;
        let selectedStudent = '';
        let backgroundMusic;
        const targetEmail = 'ok2015forever@qq.com';
        const maxRollTime = 4000; // 4秒内完成随机选择
        const rollSpeed = 50; // 每50ms切换一次
        
        // 初始化背景音乐
        function initBackgroundMusic() {
            backgroundMusic = new Audio();
            // 在实际应用中，这里应该指向您的background.mp3文件
            // backgroundMusic.src = './music/background.mp3';
            
            // 由于跨域限制，这里使用一个在线示例音乐
            backgroundMusic.src = 'https://assets.mixkit.co/music/preview/mixkit-tech-house-vibes-130.mp3';
            backgroundMusic.loop = true;
            backgroundMusic.volume = 0.5;
            
            // 设置自动播放策略
            backgroundMusic.autoplay = true;
        }
        
        // 验证密码
        startBtn.addEventListener('click', function() {
            if (passwordInput.value === SYSTEM_PASSWORD) {
                passwordSection.style.display = 'none';
                mainSection.style.display = 'flex';
                status.textContent = '系统已启动，准备开始点名';
                initBackgroundMusic();
            } else {
                alert('密码错误，请重新输入！');
                passwordInput.value = '';
                passwordInput.focus();
            }
        });
        
        // 开始点名
        startRollBtn.addEventListener('click', function() {
            if (isRolling) return;
            
            isRolling = true;
            startRollBtn.disabled = true;
            stopRollBtn.disabled = false;
            scoreSection.style.display = 'none';
            studentAvatar.style.display = 'none';
            defaultAvatar.style.display = 'block';
            beautyOverlay.style.display = 'none';
            status.textContent = '正在随机选择学生...';
            timer.style.display = 'block';
            
            // 自动播放背景音乐
            if (backgroundMusic) {
                const playPromise = backgroundMusic.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        console.log('背景音乐自动播放成功');
                    }).catch(error => {
                        console.log('背景音乐自动播放失败:', error);
                        document.addEventListener('click', function playOnClick() {
                            backgroundMusic.play();
                            document.removeEventListener('click', playOnClick);
                        });
                    });
                }
            }
            
            // 开始滚动显示学生名单
            let rollCount = 0;
            let timeLeft = maxRollTime / 1000;
            
            // 更新计时器
            const timerInterval = setInterval(() => {
                timeLeft -= 0.05;
                timer.textContent = timeLeft.toFixed(1) + '秒';
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                }
            }, 50);
            
            rollInterval = setInterval(function() {
                const randomIndex = Math.floor(Math.random() * studentList.length);
                studentName.textContent = studentList[randomIndex];
                studentName.style.fontSize = '3rem';
                studentName.style.color = 'white';
                
                rollCount += rollSpeed;
                if (rollCount >= maxRollTime) {
                    clearInterval(timerInterval);
                    stopRolling();
                }
            }, rollSpeed);
        });
        
        // 停止点名
        stopRollBtn.addEventListener('click', function() {
            if (!isRolling) return;
            stopRolling();
        });
        
        // 停止滚动并选择学生
        function stopRolling() {
            clearInterval(rollInterval);
            
            const randomIndex = Math.floor(Math.random() * studentList.length);
            selectedStudent = studentList[randomIndex];
            
            studentName.textContent = selectedStudent;
            studentName.style.fontSize = '4rem';
            studentName.style.color = '#ffeb3b';
            
            if (backgroundMusic) {
                backgroundMusic.pause();
                backgroundMusic.currentTime = 0;
            }
            
            // 显示学生真实头像
            showStudentAvatar(selectedStudent);
            playCongratulations(selectedStudent);
            createConfetti();
            createStars();
            
            status.textContent = `恭喜 ${selectedStudent} 同学被选中！`;
            timer.style.display = 'none';
            
            isRolling = false;
            startRollBtn.disabled = false;
            stopRollBtn.disabled = true;
            
            setTimeout(function() {
                scoreSection.style.display = 'flex';
                selectedStudentName.textContent = selectedStudent;
                scoreInput.focus();
            }, 3000);
        }
        
        // 显示学生头像（带美颜效果）
        function showStudentAvatar(student) {
            // 在实际应用中，这里应该指向您的头像文件夹
            // 假设头像存储在 images/ 文件夹下，格式为 jpg
            const avatarPath = `./images/${student}.jpg`;
            
            // 设置学生头像
            studentAvatar.src = avatarPath;
            studentAvatar.style.display = 'block';
            defaultAvatar.style.display = 'none';
            beautyOverlay.style.display = 'block';
            
            // 应用美颜滤镜
            applyBeautyFilter();
            
            // 3秒后恢复默认头像
            setTimeout(function() {
                studentAvatar.style.display = 'none';
                defaultAvatar.style.display = 'block';
                beautyOverlay.style.display = 'none';
            }, 3000);
            
            // 如果头像加载失败，使用备用方案
            studentAvatar.onerror = function() {
                console.log(`头像加载失败: ${avatarPath}`);
                // 使用生成的彩色头像作为备用
                createFallbackAvatar(student);
            };
        }
        
        // 应用美颜滤镜
        function applyBeautyFilter() {
            // 使用CSS滤镜实现美颜效果
            studentAvatar.style.filter = 'brightness(1.15) contrast(1.1) saturate(1.25) hue-rotate(-5deg) blur(0.3px)';
            
            // 添加柔光效果
            beautyOverlay.style.background = 'radial-gradient(circle at 30% 30%, rgba(255,255,255,0.4) 0%, transparent 50%), radial-gradient(circle at 70% 70%, rgba(255,255,255,0.2) 0%, transparent 50%)';
            beautyOverlay.style.mixBlendMode = 'overlay';
        }
        
        // 创建备用头像（当真实头像不存在时）
        function createFallbackAvatar(student) {
            const avatarColors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F'];
            const color = avatarColors[Math.floor(Math.random() * avatarColors.length)];
            
            const canvas = document.createElement('canvas');
            canvas.width = 200;
            canvas.height = 200;
            const ctx = canvas.getContext('2d');
            
            // 绘制背景
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(100, 100, 90, 0, Math.PI * 2);
            ctx.fill();
            
            // 绘制文字
            ctx.fillStyle = 'white';
            ctx.font = 'bold 60px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(student.charAt(0), 100, 100);
            
            studentAvatar.src = canvas.toDataURL();
            beautyOverlay.style.display = 'block';
        }
        
        // 播放恭喜语音
        function playCongratulations(student) {
            const speech = new SpeechSynthesisUtterance(`恭喜${student}同学中奖啦`);
            speech.lang = 'zh-CN';
            speech.rate = 1.0;
            speech.pitch = 1.2;
            window.speechSynthesis.speak(speech);
        }
        
        // 创建彩色纸屑效果
        function createConfetti() {
            const colors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4CAF50'];
            
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 2 + 's';
                studentDisplay.appendChild(confetti);
                
                setTimeout(() => {
                    confetti.remove();
                }, 3000);
            }
        }
        
        // 创建闪烁星星效果
        function createStars() {
            for (let i = 0; i < 50; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 2 + 's';
                avatarDisplay.appendChild(star);
                
                setTimeout(() => {
                    star.remove();
                }, 3000);
            }
        }
        
        // 提交分数
        submitScoreBtn.addEventListener('click', function() {
            const score = scoreInput.value.trim();
            
            if (!score || isNaN(score) || score < -100 || score > 100) {
                alert('请输入-100到100之间的有效分数！');
                scoreInput.focus();
                return;
            }
            
            loadingIndicator.style.display = 'block';
            submitScoreBtn.disabled = true;
            
            const record = {
                student: selectedStudent,
                score: score,
                date: new Date().toLocaleString()
            };
            
            status.textContent = `已记录 ${selectedStudent} 的分数: ${score}分`;
            
            // 发送邮件
            sendEmail(record);
        });
        
        // 发送邮件函数
        async function sendEmail(record) {
            try {
                const response = await fetch('send_email.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        student: record.student,
                        score: record.score,
                        date: record.date,
                        targetEmail: targetEmail
                    })
                });
                
                const result = await response.json();
                
                loadingIndicator.style.display = 'none';
                submitScoreBtn.disabled = false;
                
                if (result.success) {
                    status.innerHTML = `<span class="success-message">已将 ${record.student} 的分数记录发送到指定邮箱</span>`;
                    
                    // 重置界面
                    scoreSection.style.display = 'none';
                    scoreInput.value = '';
                    studentName.textContent = '准备开始';
                    studentName.style.fontSize = '3rem';
                    studentName.style.color = 'white';
                } else {
                    status.innerHTML = `<span class="error-message">邮件发送失败: ${result.message}</span>`;
                }
            } catch (error) {
                loadingIndicator.style.display = 'none';
                submitScoreBtn.disabled = false;
                status.innerHTML = `<span class="error-message">网络错误: ${error.message}</span>`;
            }
        }
        
        // 按Enter键提交密码
        passwordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                startBtn.click();
            }
        });
        
        // 按Enter键提交分数
        scoreInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                submitScoreBtn.click();
            }
        });
    </script>
</body>
</html>
