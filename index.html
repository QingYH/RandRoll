<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜ç­‰æ•°å­¦è¯¾å ‚éšæœºç‚¹åç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2980, #26d0ce);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            overflow: hidden;
        }
        
        .container {
            width: 90%;
            max-width: 900px;
            background: rgba(0, 20, 40, 0.85);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .container::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
            z-index: -1;
        }
        
        h1 {
            margin-bottom: 20px;
            color: #FFD700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            font-size: 2.5rem;
        }
        
        .password-section {
            margin-bottom: 30px;
        }
        
        .password-section p {
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        input {
            padding: 12px 20px;
            border: none;
            border-radius: 50px;
            width: 70%;
            max-width: 300px;
            font-size: 16px;
            margin: 10px 0;
            text-align: center;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }
        
        button {
            padding: 12px 30px;
            border: none;
            border-radius: 50px;
            background: linear-gradient(45deg, #1a2980, #26d0ce);
            color: white;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin: 20px 0;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        .main-content {
            display: none;
        }
        
        .rolling-container {
            height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }
        
        .student-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.5s;
        }
        
        .avatar-container {
            position: relative;
            width: 220px;
            height: 220px;
            margin-bottom: 20px;
        }
        
        .avatar {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 5px solid white;
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.5);
            background-size: cover;
            background-position: center;
            background-color: #f0f8ff;
            transition: opacity 0.5s ease;
            /* ç¾é¢œæ»¤é•œæ•ˆæœ */
            filter: brightness(1.1) contrast(1.1) saturate(1.2) blur(0.3px);
            position: relative;
            overflow: hidden;
        }
        
        .avatar::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.3) 0%, transparent 50%),
                       radial-gradient(circle at 70% 70%, rgba(255,255,255,0.2) 0%, transparent 50%);
            mix-blend-mode: overlay;
            pointer-events: none;
        }
        
        .avatar::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 50%),
                       linear-gradient(135deg, rgba(255,182,193,0.1) 0%, transparent 50%);
            mix-blend-mode: soft-light;
            pointer-events: none;
        }
        
        .avatar.hidden {
            opacity: 0;
        }
        
        .name {
            font-size: 48px;
            font-weight: bold;
            color: #9c27b0; /* ç´«è‰² */
            text-shadow: 0 0 15px rgba(156, 39, 176, 0.7);
            margin: 10px 0;
            transition: all 0.3s;
            letter-spacing: 2px;
        }
        
        .name.large {
            font-size: 64px;
            margin-top: 40px;
        }
        
        .rolling .name {
            font-size: 42px;
            color: white;
            text-shadow: none;
        }
        
        .status {
            margin-top: 20px;
            font-size: 22px;
            color: #FFD700;
            height: 30px;
            font-weight: bold;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        
        .math-symbols {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        
        .math-symbol {
            position: absolute;
            font-size: 28px;
            color: rgba(255, 255, 255, 0.4);
            animation: float 15s infinite linear;
        }
        
        @keyframes float {
            0% {
                transform: translateY(100px) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) rotate(360deg);
                opacity: 0;
            }
        }
        
        .audio-control {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .audio-control:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .audio-control i {
            font-size: 20px;
            color: white;
        }
        
        .like-icon {
            position: absolute;
            font-size: 120px;
            color: #FF4081;
            opacity: 0;
            transition: opacity 0.5s ease;
            z-index: 10;
            text-shadow: 0 0 20px rgba(255, 64, 129, 0.7);
            bottom: 50px;
            right: 50px;
        }
        
        .like-icon.show {
            opacity: 1;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .beauty-effect {
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.4) 0%, transparent 70%),
                       radial-gradient(circle at 70% 20%, rgba(255,182,193,0.3) 0%, transparent 70%),
                       radial-gradient(circle at 50% 80%, rgba(173,216,230,0.2) 0%, transparent 70%);
            mix-blend-mode: overlay;
            pointer-events: none;
            z-index: 2;
        }
        
        .star {
            position: absolute;
            font-size: 20px;
            animation: starTwinkle 2s infinite;
            opacity: 0;
            z-index: 3;
        }
        
        .flower {
            position: absolute;
            font-size: 16px;
            animation: flowerFloat 3s infinite;
            opacity: 0;
            z-index: 3;
        }
        
        @keyframes starTwinkle {
            0%, 100% { opacity: 0; transform: scale(0) rotate(0deg); }
            50% { opacity: 1; transform: scale(1) rotate(180deg); }
        }
        
        @keyframes flowerFloat {
            0% { opacity: 0; transform: translateY(0) rotate(0deg); }
            20% { opacity: 1; transform: translateY(-10px) rotate(90deg); }
            80% { opacity: 1; transform: translateY(-20px) rotate(180deg); }
            100% { opacity: 0; transform: translateY(-30px) rotate(270deg); }
        }
        
        .loading-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            margin: 10px 0;
            overflow: hidden;
            display: none;
        }
        
        .loading-progress {
            height: 100%;
            background: linear-gradient(90deg, #1a2980, #26d0ce);
            border-radius: 3px;
            width: 0%;
            transition: width 0.3s;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="container">
        <h1>é«˜ç­‰æ•°å­¦è¯¾å ‚éšæœºç‚¹åæé—®ç³»ç»Ÿ</h1>
        
        <div class="password-section">
            <p>è¯·è¾“å…¥æ•™å¸ˆå¯†ç è¿›å…¥ç³»ç»Ÿ</p>
            <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç ">
            <button id="login-btn">è¿›å…¥ç³»ç»Ÿ</button>
        </div>
        
        <div class="main-content">
            <div class="audio-control" id="audio-control">
                <i class="fas fa-volume-up"></i>
            </div>
            
            <div class="math-symbols" id="math-symbols"></div>
            
            <div class="rolling-container">
                <div class="like-icon" id="like-icon">
                    <i class="fas fa-thumbs-up"></i>
                </div>
                <div class="student-display" id="student-display">
                    <div class="avatar-container">
                        <div class="avatar" id="avatar"></div>
                        <div class="beauty-effect" id="beauty-effect"></div>
                    </div>
                    <div class="name" id="name">ç‚¹å‡»å¼€å§‹æŒ‰é’®</div>
                </div>
            </div>
            
            <div class="loading-bar" id="loading-bar">
                <div class="loading-progress" id="loading-progress"></div>
            </div>
            
            <div class="status" id="status">å‡†å¤‡å¼€å§‹ç‚¹å</div>
            
            <div class="controls">
                <button id="start-btn">å¼€å§‹ç‚¹å</button>
                <button id="reset-btn">é‡ç½®ç³»ç»Ÿ</button>
            </div>
        </div>
    </div>

    <script>
        // ç³»ç»Ÿå¯†ç 
        const PASSWORD = "math123";
        
        // å­¦ç”Ÿåå•ï¼ˆæ ¹æ®Excelæ•°æ®ï¼Œæ¯ä¸ªå­¦ç”Ÿæœ‰å›ºå®šçš„å¤´åƒï¼‰
        const students = [
            { name: "å¾è‹¥ä¼½", avatar: "images/å¾è‹¥ä¼½.jpg" },
            { name: "ç¨‹å­æ˜‚", avatar: "images/ç¨‹å­æ˜‚.jpg" },
            { name: "æœ±é™è•¾", avatar: "images/æœ±é™è•¾.jpg" },
            { name: "ç‹ç¡•", avatar: "images/ç‹ç¡•.jpg" },
            { name: "é‚¹å¥ä¹", avatar: "images/é‚¹å¥ä¹.jpg" },
            { name: "å´å­æ¶µ", avatar: "images/å´å­æ¶µ.jpg" },
            { name: "å¼ æ€¡", avatar: "images/å¼ æ€¡.jpg" },
            { name: "èƒ¡æ’è¿œ", avatar: "images/èƒ¡æ’è¿œ.jpg" },
            { name: "å¤å¤©é¦™", avatar: "images/å¤å¤©é¦™.jpg" },
            { name: "è°¢æ¶µ", avatar: "images/è°¢æ¶µ.jpg" },
            { name: "æœ±èŠ®", avatar: "images/æœ±èŠ®.jpg" },
            { name: "ææ¬£æ€¡", avatar: "images/ææ¬£æ€¡.jpg" },
            { name: "ä¿å…‰ç‡•", avatar: "images/ä¿å…‰ç‡•.jpg" },
            { name: "éƒ­è‹±å§¿", avatar: "images/éƒ­è‹±å§¿.jpg" },
            { name: "å¼ å¤©ä¹", avatar: "images/å¼ å¤©ä¹.jpg" },
            { name: "æä¹ä¹", avatar: "images/æä¹ä¹.jpg" },
            { name: "æå¿—è±ª", avatar: "images/æå¿—è±ª.jpg" },
            { name: "æ¨ç¡•", avatar: "images/æ¨ç¡•.jpg" },
            { name: "æ¨é‹†å¦", avatar: "images/æ¨é‹†å¦.jpg" },
            { name: "é‡‘å®‡", avatar: "images/é‡‘å®‡.jpg" },
            { name: "èƒ¡æ–‡è¿œ", avatar: "images/èƒ¡æ–‡è¿œ.jpg" },
            { name: "èƒ¡é›¨æ¬£", avatar: "images/èƒ¡é›¨æ¬£.jpg" },
            { name: "å¸¸ä¿Š", avatar: "images/å¸¸ä¿Š.jpg" },
            { name: "éŸ¦ä¹¦æˆ", avatar: "images/éŸ¦ä¹¦æˆ.jpg" },
            { name: "æ±¤å­æ‰¬", avatar: "images/æ±¤å­æ‰¬.jpg" },
            { name: "é˜®å®¶è±ª", avatar: "images/é˜®å®¶è±ª.jpg" },
            { name: "ä½•ä¿Šæ°", avatar: "images/ä½•ä¿Šæ°.jpg" },
            { name: "å•å®‡é˜³", avatar: "images/å•å®‡é˜³.jpg" },
            { name: "å§šå‹‡æ£‹", avatar: "images/å§šå‹‡æ£‹.jpg" },
            { name: "æ®µæµ·å†°", avatar: "images/æ®µæµ·å†°.jpg" },
            { name: "å”äºš", avatar: "images/å”äºš.jpg" },
            { name: "é²ç‘é”‹", avatar: "images/é²ç‘é”‹.jpg" },
            { name: "è”¡è´¤è¿", avatar: "images/è”¡è´¤è¿.jpg" },
            { name: "æ–¹æµ·æ¶›", avatar: "images/æ–¹æµ·æ¶›.jpg" },
            { name: "éŸ¦å®‡æ’", avatar: "images/éŸ¦å®‡æ’.jpg" },
            { name: "éŸ¦å˜‰ä¹", avatar: "images/éŸ¦å˜‰ä¹.jpg" },
            { name: "ç‹æ˜Šå®‡", avatar: "images/ç‹æ˜Šå®‡.jpg" },
            { name: "ç‹ç‘ç¦", avatar: "images/ç‹ç‘ç¦.jpg" },
            { name: "å¶å•Ÿå†›", avatar: "images/å¶å•Ÿå†›.jpg" },
            { name: "å¹´åšä¸€", avatar: "images/å¹´åšä¸€.jpg" },
            { name: "åˆ˜å­é¾™", avatar: "images/åˆ˜å­é¾™.jpg" },
            { name: "åˆ˜ç‘", avatar: "images/åˆ˜ç‘.jpg" },
            { name: "æœ±å‹‹æŒ¯", avatar: "images/æœ±å‹‹æŒ¯.jpg" },
            { name: "å¼ å®‡æ´‹", avatar: "images/å¼ å®‡æ´‹.jpg" },
            { name: "å¼ æµ©å®‡", avatar: "images/å¼ æµ©å®‡.jpg" },
            { name: "æä¿Šæ°", avatar: "images/æä¿Šæ°.jpg" },
            { name: "æ¨æ–‡å®‡", avatar: "images/æ¨æ–‡å®‡.jpg" },
            { name: "æ¨æ ‘å›­", avatar: "images/æ¨æ ‘å›­.jpg" },
            { name: "æ¨ç››æµ©", avatar: "images/æ¨ç››æµ©.jpg" },
            { name: "å”å¿—è¿œ", avatar: "images/å”å¿—è¿œ.jpg" },
            { name: "å¤äº‘å‹‡", avatar: "images/å¤äº‘å‹‡.jpg" },
            { name: "è°¢è¶…", avatar: "images/è°¢è¶….jpg" },
            { name: "æ¯›è¿æœ", avatar: "images/æ¯›è¿æœ.jpg" },
            { name: "éŸ¦ç‰", avatar: "images/éŸ¦ç‰.jpg" },
            { name: "å­™è€€å¤", avatar: "images/å­™è€€å¤.jpg" },
            { name: "æœ±è¡Œè·ƒ", avatar: "images/æœ±è¡Œè·ƒ.jpg" },
            { name: "é™ˆå¯ç¿", avatar: "images/é™ˆå¯ç¿.jpg" },
            { name: "å§šæ™ºé¹", avatar: "images/å§šæ™ºé¹.jpg" },
            { name: "éŸ©ç´«å«£", avatar: "images/éŸ©ç´«å«£.jpg" },
            { name: "ç‹ç«¥", avatar: "images/ç‹ç«¥.jpg" },
            { name: "å¶å©·å©·", avatar: "images/å¶å©·å©·.jpg" },
            { name: "ç«¥æ¬£æ€¡", avatar: "images/ç«¥æ¬£æ€¡.jpg" },
            { name: "èˆ’æ™ºæ–‡", avatar: "images/èˆ’æ™ºæ–‡.jpg" },
            { name: "éŸ©ç‰æ´", avatar: "images/éŸ©ç‰æ´.jpg" },
            { name: "æ¢æ™–", avatar: "images/æ¢æ™–.jpg" },
            { name: "è°­æ…§æ…§", avatar: "images/è°­æ…§æ…§.jpg" },
            { name: "é©¬é‘«å®‡", avatar: "images/é©¬é‘«å®‡.jpg" },
            { name: "å­”è‰ºæ¶µ", avatar: "images/å­”è‰ºæ¶µ.jpg" },
            { name: "æ–¹ç‰è¾¾", avatar: "images/æ–¹ç‰è¾¾.jpg" },
            { name: "ç‹æ¢¦äº‘", avatar: "images/ç‹æ¢¦äº‘.jpg" },
            { name: "å¼ æ¢¦å©·", avatar: "images/å¼ æ¢¦å©·.jpg" },
            { name: "æˆ¿é“¶éœ", avatar: "images/æˆ¿é“¶éœ.jpg" },
            { name: "æ¢å¿ƒæ€¡", avatar: "images/æ¢å¿ƒæ€¡.jpg" },
            { name: "æ¢å®‡ç¨", avatar: "images/æ¢å®‡ç¨.jpg" },
            { name: "éœæµ©ç„¶", avatar: "images/éœæµ©ç„¶.jpg" },
            { name: "ä¸å®‡è½©", avatar: "images/ä¸å®‡è½©.jpg" },
            { name: "é©¬è‡ªçº¢", avatar: "images/é©¬è‡ªçº¢.jpg" },
            { name: "ç‰›å¥½", avatar: "images/ç‰›å¥½.jpg" },
            { name: "æ±Ÿæµ·æ¶›", avatar: "images/æ±Ÿæµ·æ¶›.jpg" },
            { name: "å¼ å®¶ç¦", avatar: "images/å¼ å®¶ç¦.jpg" },
            { name: "ç½—æ—¶æ­¦", avatar: "images/ç½—æ—¶æ­¦.jpg" },
            { name: "èƒ¡è€€", avatar: "images/èƒ¡è€€.jpg" },
            { name: "èµµç´«æ¶µ", avatar: "images/èµµç´«æ¶µ.jpg" },
            { name: "é«˜åº†é¹", avatar: "images/é«˜åº†é¹.jpg" },
            { name: "ç››æ–‡æ¶›", avatar: "images/ç››æ–‡æ¶›.jpg" },
            { name: "åå‹‡ä¹", avatar: "images/åå‹‡ä¹.jpg" },
            { name: "æœ±è´¤æ¶›", avatar: "images/æœ±è´¤æ¶›.jpg" },
            { name: "å¼ ç‰æ´", avatar: "images/å¼ ç‰æ´.jpg" },
            { name: "å¼ é¸£å¨", avatar: "images/å¼ é¸£å¨.jpg" },
            { name: "å¼ æ’", avatar: "images/å¼ æ’.jpg" },
            { name: "æ¨ä½³æ€¡", avatar: "images/æ¨ä½³æ€¡.jpg" },
            { name: "é™ˆå®¶ä¹", avatar: "images/é™ˆå®¶ä¹.jpg" },
            { name: "æ˜åä¸œ", avatar: "images/æ˜åä¸œ.jpg" },
            { name: "å§šçŒ›", avatar: "images/å§šçŒ›.jpg" },
            { name: "é¡¹å¯ç›Š", avatar: "images/é¡¹å¯ç›Š.jpg" },
            { name: "æ¹›ç›Šé˜³", avatar: "images/æ¹›ç›Šé˜³.jpg" }
        ];
        
        // æ•°å­¦ç¬¦å·
        const mathSymbols = ["âˆ«", "âˆ‘", "âˆ", "âˆš", "âˆ", "âˆ‚", "âˆ†", "âˆ‡", "âˆ", "âˆ ", "âŠ¥", "âˆ¥", "âˆ©", "âˆª", "âˆˆ", "âˆ‰", "âˆ€", "âˆƒ", "âˆ´", "âˆµ", "â‰¤", "â‰¥", "â‰ ", "â‰ˆ", "â‰¡"];
        
        // DOMå…ƒç´ 
        const passwordSection = document.querySelector('.password-section');
        const mainContent = document.querySelector('.main-content');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('login-btn');
        const startBtn = document.getElementById('start-btn');
        const resetBtn = document.getElementById('reset-btn');
        const studentDisplay = document.getElementById('student-display');
        const avatar = document.getElementById('avatar');
        const nameElement = document.getElementById('name');
        const statusElement = document.getElementById('status');
        const mathSymbolsContainer = document.getElementById('math-symbols');
        const audioControl = document.getElementById('audio-control');
        const likeIcon = document.getElementById('like-icon');
        const beautyEffect = document.getElementById('beauty-effect');
        const avatarContainer = document.querySelector('.avatar-container');
        const loadingBar = document.getElementById('loading-bar');
        const loadingProgress = document.getElementById('loading-progress');
        
        // éŸ³é¢‘å…ƒç´ 
        let backgroundMusic = null;
        let applauseSound = null;
        let isMusicPlaying = false;

        // å¤´åƒç®¡ç†ç³»ç»Ÿ - å½»åº•ä¿®å¤å¤´åƒæ˜¾ç¤ºé—®é¢˜
        const avatarCache = new Map();
        let avatarPreloadComplete = false;
        let currentRollingInterval = null;
        let currentRollingPromise = Promise.resolve();

        // é¢„åŠ è½½æ‰€æœ‰å¤´åƒåˆ°ç¼“å­˜
        function preloadAllAvatars() {
            return new Promise((resolve) => {
                console.log("å¼€å§‹é¢„åŠ è½½æ‰€æœ‰å¤´åƒ...");
                let loadedCount = 0;
                const totalCount = students.length;
                
                // æ˜¾ç¤ºåŠ è½½è¿›åº¦æ¡
                loadingBar.style.display = 'block';
                loadingProgress.style.width = '0%';

                students.forEach((student, index) => {
                    // å¦‚æœå·²ç»åœ¨ç¼“å­˜ä¸­ï¼Œè·³è¿‡
                    if (avatarCache.has(student.avatar)) {
                        loadedCount++;
                        updateProgress(loadedCount, totalCount);
                        checkCompletion();
                        return;
                    }

                    const img = new Image();
                    img.onload = function() {
                        avatarCache.set(student.avatar, {
                            element: img,
                            loaded: true,
                            url: student.avatar
                        });
                        loadedCount++;
                        updateProgress(loadedCount, totalCount);
                        console.log(`å¤´åƒé¢„åŠ è½½æˆåŠŸ: ${student.name} (${loadedCount}/${totalCount})`);
                        checkCompletion();
                    };
                    img.onerror = function() {
                        console.warn(`å¤´åƒé¢„åŠ è½½å¤±è´¥: ${student.name}`);
                        // å³ä½¿å¤±è´¥ä¹Ÿè®°å½•ï¼Œé¿å…é˜»å¡
                        avatarCache.set(student.avatar, {
                            element: null,
                            loaded: false,
                            url: student.avatar
                        });
                        loadedCount++;
                        updateProgress(loadedCount, totalCount);
                        checkCompletion();
                    };
                    // æ·»åŠ æ—¶é—´æˆ³é¿å…ç¼“å­˜é—®é¢˜
                    img.src = `${student.avatar}?t=${new Date().getTime()}`;
                });

                function updateProgress(current, total) {
                    const percent = Math.round((current / total) * 100);
                    loadingProgress.style.width = `${percent}%`;
                }

                function checkCompletion() {
                    if (loadedCount === totalCount) {
                        avatarPreloadComplete = true;
                        console.log("æ‰€æœ‰å¤´åƒé¢„åŠ è½½å®Œæˆ");
                        // éšè—åŠ è½½è¿›åº¦æ¡
                        setTimeout(() => {
                            loadingBar.style.display = 'none';
                        }, 500);
                        resolve();
                    }
                }

                // å¦‚æœå­¦ç”Ÿåˆ—è¡¨ä¸ºç©ºï¼Œç«‹å³å®Œæˆ
                if (totalCount === 0) {
                    avatarPreloadComplete = true;
                    loadingBar.style.display = 'none';
                    resolve();
                }
            });
        }

        // å®‰å…¨æ˜¾ç¤ºå¤´åƒå‡½æ•° - å½»åº•ä¿®å¤ç‰ˆæœ¬
        function safelyDisplayAvatar(student) {
            return new Promise((resolve) => {
                // ç«‹å³è®¾ç½®å§“å
                nameElement.textContent = student.name;

                // æ£€æŸ¥ç¼“å­˜ä¸­æ˜¯å¦æœ‰è¯¥å¤´åƒ
                const cached = avatarCache.get(student.avatar);
                
                if (cached && cached.loaded && cached.element) {
                    // ä»ç¼“å­˜ä¸­æ˜¾ç¤º
                    avatar.style.backgroundImage = `url("${student.avatar}")`;
                    console.log(`âœ“ ä»ç¼“å­˜æ˜¾ç¤ºå¤´åƒ: ${student.name}`);
                    resolve();
                    return;
                }

                // å¦‚æœä¸åœ¨ç¼“å­˜ä¸­æˆ–åŠ è½½å¤±è´¥ï¼Œé‡æ–°åŠ è½½
                console.log(`ğŸ”„ é‡æ–°åŠ è½½å¤´åƒ: ${student.name}`);
                const img = new Image();
                img.onload = function() {
                    avatarCache.set(student.avatar, {
                        element: img,
                        loaded: true,
                        url: student.avatar
                    });
                    avatar.style.backgroundImage = `url("${student.avatar}")`;
                    console.log(`âœ“ å®æ—¶åŠ è½½å¤´åƒæˆåŠŸ: ${student.name}`);
                    resolve();
                };
                img.onerror = function() {
                    console.warn(`âŒ å¤´åƒåŠ è½½å¤±è´¥: ${student.name}`);
                    // ä½¿ç”¨é»˜è®¤å¤´åƒæˆ–ä¿æŒå½“å‰æ˜¾ç¤º
                    avatar.style.backgroundImage = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    // æ ‡è®°ä¸ºåŠ è½½å¤±è´¥
                    avatarCache.set(student.avatar, {
                        element: null,
                        loaded: false,
                        url: student.avatar
                    });
                    resolve();
                };
                
                // æ·»åŠ æ—¶é—´æˆ³é¿å…ç¼“å­˜é—®é¢˜
                const timestamp = new Date().getTime();
                img.src = `${student.avatar}?t=${timestamp}`;
            });
        }

        // åˆ›å»ºæ•°å­¦ç¬¦å·
        function createMathSymbols() {
            for (let i = 0; i < 25; i++) {
                const symbol = document.createElement('div');
                symbol.className = 'math-symbol';
                symbol.textContent = mathSymbols[Math.floor(Math.random() * mathSymbols.length)];
                symbol.style.left = `${Math.random() * 100}%`;
                symbol.style.animationDelay = `${Math.random() * 15}s`;
                mathSymbolsContainer.appendChild(symbol);
            }
        }
        
        // åˆ›å»ºå½©è‰²å°æ˜Ÿæ˜Ÿå’ŒèŠ±æœµ
        function createDecorations() {
            // æ¸…é™¤ä¹‹å‰çš„è£…é¥°
            const existingDecorations = avatarContainer.querySelectorAll('.star, .flower');
            existingDecorations.forEach(decoration => decoration.remove());
            
            // åˆ›å»ºå½©è‰²å°æ˜Ÿæ˜Ÿ
            const starColors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#FF9FF3', '#F368E0'];
            for (let i = 0; i < 6; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.innerHTML = 'â˜…';
                star.style.left = `${Math.random() * 100}%`;
                star.style.top = `${Math.random() * 100}%`;
                star.style.color = starColors[Math.floor(Math.random() * starColors.length)];
                star.style.animationDelay = `${Math.random() * 2}s`;
                avatarContainer.appendChild(star);
            }
            
            // åˆ›å»ºèŠ±æœµ
            const flowerColors = ['#FF6B9D', '#A29BFE', '#55E6C1', '#FD7272', '#BDC581'];
            for (let i = 0; i < 4; i++) {
                const flower = document.createElement('div');
                flower.className = 'flower';
                flower.innerHTML = 'â€';
                flower.style.left = `${Math.random() * 100}%`;
                flower.style.top = `${Math.random() * 100}%`;
                flower.style.color = flowerColors[Math.floor(Math.random() * flowerColors.length)];
                flower.style.animationDelay = `${Math.random() * 3}s`;
                avatarContainer.appendChild(flower);
            }
        }
        
        // ç™»å½•éªŒè¯
        loginBtn.addEventListener('click', function() {
            if (passwordInput.value === PASSWORD) {
                passwordSection.style.display = 'none';
                mainContent.style.display = 'block';
                createMathSymbols();
                
                // é¢„åŠ è½½å¤´åƒå¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                statusElement.textContent = "æ­£åœ¨åŠ è½½å¤´åƒ...";
                preloadAllAvatars().then(() => {
                    statusElement.textContent = "å‡†å¤‡å¼€å§‹ç‚¹å";
                    console.log("ğŸ‰ å¤´åƒé¢„åŠ è½½å®Œæˆï¼Œç³»ç»Ÿå‡†å¤‡å°±ç»ª");
                }).catch(error => {
                    console.error("å¤´åƒé¢„åŠ è½½å¤±è´¥:", error);
                    statusElement.textContent = "å‡†å¤‡å¼€å§‹ç‚¹å";
                });
            } else {
                alert('å¯†ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥ï¼');
                passwordInput.value = '';
            }
        });
        
        // æŒ‰å›è½¦é”®ç™»å½•
        passwordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                loginBtn.click();
            }
        });
        
        // æ’­æ”¾èƒŒæ™¯éŸ³ä¹ï¼ˆç‚¹åè¿‡ç¨‹ä¸­ï¼‰
        function playBackgroundMusic() {
            try {
                // åœæ­¢ä¹‹å‰çš„éŸ³ä¹
                if (backgroundMusic) {
                    backgroundMusic.pause();
                    backgroundMusic.currentTime = 0;
                }
                
                // åˆ›å»ºæ–°çš„éŸ³é¢‘å®ä¾‹
                backgroundMusic = new Audio('music/background.mp3');
                backgroundMusic.volume = 0.3;
                backgroundMusic.loop = true;
                
                // æ’­æ”¾éŸ³ä¹
                const playPromise = backgroundMusic.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        isMusicPlaying = true;
                        audioControl.innerHTML = '<i class="fas fa-volume-up"></i>';
                        console.log("ğŸµ èƒŒæ™¯éŸ³ä¹å¼€å§‹æ’­æ”¾");
                    }).catch(error => {
                        console.log("èƒŒæ™¯éŸ³ä¹æ’­æ”¾å¤±è´¥:", error);
                    });
                }
            } catch (error) {
                console.log("èƒŒæ™¯éŸ³ä¹åˆå§‹åŒ–å¤±è´¥:", error);
            }
        }
        
        // åœæ­¢èƒŒæ™¯éŸ³ä¹
        function stopBackgroundMusic() {
            if (backgroundMusic) {
                backgroundMusic.pause();
                backgroundMusic.currentTime = 0;
                isMusicPlaying = false;
                console.log("â¹ï¸ èƒŒæ™¯éŸ³ä¹å·²åœæ­¢");
            }
        }
        
        // æ’­æ”¾æŒå£°
        function playApplause() {
            try {
                // åœæ­¢ä¹‹å‰çš„æŒå£°
                if (applauseSound) {
                    applauseSound.pause();
                    applauseSound.currentTime = 0;
                }
                
                // åˆ›å»ºæ–°çš„éŸ³é¢‘å®ä¾‹
                applauseSound = new Audio('music/applause.mp3');
                applauseSound.volume = 0.5;
                
                // æ’­æ”¾æŒå£°
                const playPromise = applauseSound.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        console.log("ğŸ‘ æŒå£°å¼€å§‹æ’­æ”¾");
                    }).catch(error => {
                        console.log("æŒå£°æ’­æ”¾å¤±è´¥:", error);
                    });
                }
            } catch (error) {
                console.log("æŒå£°åˆå§‹åŒ–å¤±è´¥:", error);
            }
        }
        
        // æ˜¾ç¤ºç‚¹èµå›¾æ ‡
        function showLikeIcon() {
            likeIcon.classList.add('show');
            
            // 3ç§’åéšè—ç‚¹èµå›¾æ ‡
            setTimeout(() => {
                likeIcon.classList.remove('show');
            }, 3000);
        }
        
        // åˆ‡æ¢èƒŒæ™¯éŸ³ä¹
        audioControl.addEventListener('click', function() {
            if (isMusicPlaying && backgroundMusic) {
                backgroundMusic.pause();
                isMusicPlaying = false;
                audioControl.innerHTML = '<i class="fas fa-volume-mute"></i>';
            } else if (backgroundMusic) {
                backgroundMusic.play().then(() => {
                    isMusicPlaying = true;
                    audioControl.innerHTML = '<i class="fas fa-volume-up"></i>';
                });
            }
        });
        
        let isRolling = false;
        let rollSpeed = 80; // åˆå§‹æ»šåŠ¨é€Ÿåº¦(ms)
        let totalRollTime = 5000; // æ€»æ»šåŠ¨æ—¶é—´5ç§’
        
        // å¼€å§‹ç‚¹å
        startBtn.addEventListener('click', function() {
            if (isRolling) return;
            
            isRolling = true;
            studentDisplay.classList.add('rolling');
            statusElement.textContent = "éšæœºç‚¹åä¸­...";
            startBtn.disabled = true;
            
            // é‡ç½®æ˜¾ç¤º
            avatar.classList.remove('hidden');
            nameElement.classList.remove('large');
            
            // å¼€å§‹æ’­æ”¾èƒŒæ™¯éŸ³ä¹
            playBackgroundMusic();
            
            // å¼€å§‹å¿«é€Ÿæ»šåŠ¨ - ä½¿ç”¨æ”¹è¿›çš„å¤´åƒæ˜¾ç¤ºç³»ç»Ÿ
            let lastStudentIndex = -1;
            
            // é‡ç½®æ»šåŠ¨Promiseé“¾
            currentRollingPromise = Promise.resolve();
            
            currentRollingInterval = setInterval(() => {
                let randomIndex;
                // ç¡®ä¿ä¸è¿ç»­æ˜¾ç¤ºåŒä¸€ä¸ªå­¦ç”Ÿ
                do {
                    randomIndex = Math.floor(Math.random() * students.length);
                } while (randomIndex === lastStudentIndex && students.length > 1);
                
                lastStudentIndex = randomIndex;
                const student = students[randomIndex];
                
                // ä½¿ç”¨é“¾å¼Promiseç¡®ä¿å¤´åƒæŒ‰é¡ºåºæ˜¾ç¤º
                currentRollingPromise = currentRollingPromise.then(() => {
                    return safelyDisplayAvatar(student);
                }).catch(error => {
                    console.error("å¤´åƒæ˜¾ç¤ºé”™è¯¯:", error);
                });
            }, rollSpeed);
            
            // 5ç§’ååœæ­¢
            setTimeout(stopRolling, totalRollTime);
        });
        
        // åœæ­¢æ»šåŠ¨
        function stopRolling() {
            if (currentRollingInterval) {
                clearInterval(currentRollingInterval);
                currentRollingInterval = null;
            }
            
            isRolling = false;
            studentDisplay.classList.remove('rolling');
            statusElement.textContent = "æ­å–œè¿™ä½åŒå­¦ï¼";
            
            // åœæ­¢èƒŒæ™¯éŸ³ä¹
            stopBackgroundMusic();
            
            // æ’­æ”¾æŒå£°
            playApplause();
            
            // æ˜¾ç¤ºç‚¹èµå›¾æ ‡
            showLikeIcon();
            
            // éšæœºé€‰æ‹©ä¸€ä¸ªå­¦ç”Ÿ
            const randomIndex = Math.floor(Math.random() * students.length);
            const selectedStudent = students[randomIndex];
            
            // ä½¿ç”¨å®‰å…¨å¤´åƒæ˜¾ç¤ºå‡½æ•°æ˜¾ç¤ºæœ€ç»ˆé€‰ä¸­çš„å­¦ç”Ÿ
            currentRollingPromise = currentRollingPromise.then(() => {
                return safelyDisplayAvatar(selectedStudent);
            }).then(() => {
                console.log(`ğŸ‰ æœ€ç»ˆé€‰ä¸­: ${selectedStudent.name}`);
                
                // æ·»åŠ è£…é¥°ç‰¹æ•ˆ
                createDecorations();
                
                // 3ç§’åéšè—å¤´åƒï¼Œæ”¾å¤§å§“å
                setTimeout(function() {
                    avatar.classList.add('hidden');
                    nameElement.classList.add('large');
                }, 3000);
                
                // æ’­æ”¾è¯­éŸ³ - åªæ’­æŠ¥"æ­å–œ***åŒå­¦ä¸­å¥–å•¦"
                const finalMessage = `æ­å–œ${selectedStudent.name}åŒå­¦ä¸­å¥–å•¦`;
                speakMessage(finalMessage);
                
                startBtn.disabled = false;
            });
        }
        
        // è¯­éŸ³åˆæˆ
        function speakMessage(message) {
            if ('speechSynthesis' in window) {
                // åœæ­¢ä¹‹å‰çš„è¯­éŸ³
                window.speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(message);
                utterance.rate = 0.9;
                utterance.pitch = 1.2;
                utterance.volume = 1;
                window.speechSynthesis.speak(utterance);
            }
        }
        
        // é‡ç½®ç³»ç»Ÿ
        resetBtn.addEventListener('click', function() {
            if (currentRollingInterval) {
                clearInterval(currentRollingInterval);
                currentRollingInterval = null;
            }
            
            // åœæ­¢è¯­éŸ³
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
            }
            
            // åœæ­¢éŸ³ä¹
            stopBackgroundMusic();
            
            // é‡ç½®çŠ¶æ€
            isRolling = false;
            studentDisplay.classList.remove('rolling');
            avatar.classList.remove('hidden');
            nameElement.classList.remove('large');
            nameElement.textContent = "ç‚¹å‡»å¼€å§‹æŒ‰é’®";
            statusElement.textContent = "å‡†å¤‡å¼€å§‹ç‚¹å";
            startBtn.disabled = false;
            
            // éšè—ç‚¹èµå›¾æ ‡
            likeIcon.classList.remove('show');
            
            // æ¸…é™¤è£…é¥°
            const existingDecorations = avatarContainer.querySelectorAll('.star, .flower');
            existingDecorations.forEach(decoration => decoration.remove());
        });
    </script>
</body>
</html>
